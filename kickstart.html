<script>
    document.addEventListener('DOMContentLoaded', () => {
        const MAX_PROJECTS = 16;

        var GRAPHQL_PAYLOAD = {
            operationName: null,
            variables: {},
            extensions: {},
            query:
                "{\n  pages {\n    list {\n      id\n      locale\n      path\n      title\n      description\n      createdAt\n      tags\n      }\n      }\n}",
        };

        function isFinishedProject(page) {
            var tags = page.tags || [];
            return !tags.includes("wip") && (tags.includes("big project") || tags.includes("small project"));
        }

        function populateTime(page) {
            const match = /end:(\d\d\d\d-\d\d-\d\d)/g.exec(page.description);
            const time = new Date(match ? match[1] : page.createdAt);
            return {
                ...page,
                time
            };
        }

        function enrichPage(page) {
            const tags = page.tags || [];
            const imageUrl = extractImageUrl(page.description);
            const filteredTags = tags.filter(tag => tag !== "big project" && tag !== "small project");

            return {
                ...page,
                isBigProject: tags.includes("big project"),
                imageUrl: imageUrl,
                filteredTags: filteredTags
            };
        }

        function renderDate(date) {
            return new Date(date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function extractSummary(description) {
            // Remove the end: date pattern and return first 150 characters
            const cleanDesc = (description || "").replace(/end:\d\d\d\d-\d\d-\d\d/g, "").trim();
            return cleanDesc.substring(0, 150) + (cleanDesc.length > 150 ? "..." : "");
        }

        function extractImageUrl(description) {
            // Look for image URLs in the description (jpg, jpeg, or webp)
            // Match text at start of string or after whitespace that ends with image extension
            const imageRegex = /(?:^|\s)(\S+\.(jpg|jpeg|webp))/i;
            const match = description.match(imageRegex);
            return match ? match[1] : null;
        }

        function renderCard(page) {
            const isBig = page.isBigProject;
            const imageUrl = page.imageUrl;
            const tags = page.filteredTags;

            // Create card container
            const card = document.createElement("div");
            card.style.cssText = "background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); overflow: hidden; display: flex; flex-direction: column;";

            // Create figure element with link if image exists
            const figure = document.createElement("figure");
            figure.style.cssText = "width: 100%; height: 224px; overflow: hidden; background: #f3f4f6; display: flex; align-items: center; justify-content: center; margin: 0;";

            if (imageUrl) {
                const figureLink = document.createElement("a");
                figureLink.href = page.path;
                figureLink.style.cssText = "display: block; width: 100%; height: 100%; text-decoration: none;";

                const img = document.createElement("img");
                img.src = imageUrl;
                img.alt = page.title;
                img.style.cssText = "width: 100%; height: 100%; object-fit: cover; cursor: pointer;";
                figureLink.appendChild(img);
                figure.appendChild(figureLink);
            } else {
                // Create CSS-only placeholder with circle and line
                const placeholder = document.createElement("div");
                placeholder.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    gap: 12px;
                    width: 100%;
                    height: 100%;
                `;

                const circle = document.createElement("div");
                circle.style.cssText = `
                    position: relative;
                    width: 64px;
                    height: 64px;
                    border: 2px solid #d1d5db;
                    border-radius: 50%;
                `;

                // Line across the circle
                const line = document.createElement("div");
                line.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    width: 100%;
                    height: 2px;
                    background: #d1d5db;
                    transform: translate(-50%, -50%) rotate(-45deg);
                `;
                circle.appendChild(line);

                // No image text
                const text = document.createElement("span");
                text.style.cssText = `
                    font-size: 12px;
                    color: #9ca3af;
                    font-weight: 500;
                `;
                text.textContent = "No image";

                placeholder.appendChild(circle);
                placeholder.appendChild(text);
                figure.appendChild(placeholder);
            }

            card.appendChild(figure);

            // Create card body
            const cardBody = document.createElement("div");
            cardBody.style.cssText = "padding: 20px; flex: 1; display: flex; flex-direction: column;";

            // Create title link
            const titleLink = document.createElement("a");
            titleLink.href = page.path;
            titleLink.style.cssText = "text-decoration: none; color: inherit; cursor: pointer;";

            const title = document.createElement("h2");
            title.style.cssText = "margin: 0 0 12px 0; font-size: 20px; font-weight: 700; color: #000;";
            title.textContent = isBig ? "ðŸ”¥ " + page.title : page.title;
            titleLink.appendChild(title);
            cardBody.appendChild(titleLink);

            // Create tags container
            const tagsContainer = document.createElement("div");
            tagsContainer.style.cssText = "display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0;";
            tags.forEach(tag => {
                const tagLink = document.createElement("a");
                tagLink.href = "/t/" + tag;
                tagLink.style.cssText = "display: inline-block; padding: 4px 8px; font-size: 12px; color: #666; border: 1px solid #d1d5db; border-radius: 4px; background: #f9fafb; text-decoration: none; cursor: pointer; transition: background 0.2s;";
                tagLink.textContent = tag;
                tagLink.onmouseover = function () { this.style.background = "#e5e7eb"; };
                tagLink.onmouseout = function () { this.style.background = "#f9fafb"; };
                tagsContainer.appendChild(tagLink);
            });
            cardBody.appendChild(tagsContainer);

            // Create card footer with timestamp
            const cardFooter = document.createElement("div");
            cardFooter.style.cssText = "margin-top: auto;";

            // Create timestamp
            const timestamp = document.createElement("span");
            timestamp.style.cssText = "font-size: 12px; color: #999;";
            timestamp.textContent = renderDate(page.time);
            cardFooter.appendChild(timestamp);

            cardBody.appendChild(cardFooter);
            card.appendChild(cardBody);

            return card.outerHTML;
        }

        function showGrid(data) {
            const grid = document.getElementById('projects-grid');
            grid.style.cssText = "display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px;";
            grid.innerHTML = data.map(renderCard).join('');
        }

        async function renderProjects() {
            var rawResponse = await fetch("/graphql", {
                method: "POST",
                headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json",
                },
                credentials: "same-origin",
                body: JSON.stringify(GRAPHQL_PAYLOAD),
            });
            var content = await rawResponse.json();
            var projects = content.data.pages.list
                .filter(isFinishedProject)
                .map(populateTime)
                .map(enrichPage)
                .sort((a, b) => new Date(b.time) - new Date(a.time))
                .slice(0, MAX_PROJECTS);

            showGrid(projects);
        }
        renderProjects();
    });
</script>
